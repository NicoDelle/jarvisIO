#include <Arduino.h>
#include <PDM.h>
#include <WiFiNINA.h>

#include "jarvis.h"
#include "jarvis030.h"
float melSpectrogram[ROWS][COLS] = {{-7.62939453125e-06, -17.63501739501953, -20.468284606933594, -11.05853271484375, -9.554634094238281, -9.233329772949219, -9.362068176269531, -11.909446716308594, -12.324508666992188, -15.902580261230469, -20.18286895751953, -21.185829162597656, -16.102500915527344, -13.864273071289062, -11.909858703613281, -18.441062927246094, -27.91728973388672, -33.53229522705078, -33.19703674316406, -35.17528533935547, -35.42943572998047},
{-8.236190795898438, -43.45757293701172, -20.478050231933594, -6.149864196777344, -5.151145935058594, -5.895195007324219, -6.3376922607421875, -9.721168518066406, -8.668045043945312, -10.369895935058594, -11.382652282714844, -14.779800415039062, -13.619064331054688, -12.682594299316406, -10.107246398925781, -16.589012145996094, -26.520828247070312, -34.71452331542969, -39.299591064453125, -46.26625061035156, -43.92211151123047},
{-12.262962341308594, -52.00000762939453, -26.17023468017578, -14.693550109863281, -12.803787231445312, -19.1190185546875, -22.978858947753906, -34.628517150878906, -31.042510986328125, -20.864852905273438, -24.49444580078125, -30.124099731445312, -37.745635986328125, -35.828697204589844, -37.04522705078125, -36.56431579589844, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -50.848487854003906},
{-14.799560546875, -52.00000762939453, -32.486488342285156, -12.976211547851562, -13.056983947753906, -17.162384033203125, -15.827064514160156, -28.08008575439453, -29.348709106445312, -20.36719512939453, -19.598342895507812, -27.41204071044922, -33.79876708984375, -33.911041259765625, -29.941017150878906, -40.21874237060547, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-16.82147979736328, -52.00000762939453, -34.28880310058594, -5.72467041015625, -4.609947204589844, -5.240928649902344, -5.264640808105469, -17.840309143066406, -21.128562927246094, -18.045494079589844, -28.378578186035156, -27.212173461914062, -25.60710906982422, -29.624053955078125, -22.623497009277344, -31.36724090576172, -49.45145034790039, -49.07636642456055, -52.00000762939453, -52.00000762939453, -50.40334701538086},
{-18.4239501953125, -52.00000762939453, -35.851837158203125, -8.820968627929688, -10.270790100097656, -15.797523498535156, -17.837020874023438, -30.025352478027344, -24.042945861816406, -21.618255615234375, -25.10283660888672, -28.486251831054688, -35.34320068359375, -36.45677947998047, -34.929603576660156, -41.32722854614258, -52.00000762939453, -49.94184875488281, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-19.756683349609375, -52.00000762939453, -38.66912078857422, -18.125328063964844, -17.791221618652344, -26.25787353515625, -33.840538024902344, -49.882164001464844, -37.24828338623047, -18.89258575439453, -19.32062530517578, -35.221336364746094, -38.37543487548828, -41.00444793701172, -38.882080078125, -51.09760665893555, -51.256221771240234, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-20.96820831298828, -52.00000762939453, -41.05263137817383, -23.21338653564453, -30.751380920410156, -34.36578369140625, -41.420928955078125, -52.00000762939453, -45.30777359008789, -26.439239501953125, -19.187095642089844, -38.40610885620117, -47.065914154052734, -46.8953971862793, -49.5925407409668, -49.6214714050293, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-21.91351318359375, -52.00000762939453, -44.19139099121094, -29.167335510253906, -31.53125, -35.43437194824219, -43.814449310302734, -52.00000762939453, -47.15104675292969, -42.551387786865234, -37.948280334472656, -48.95396041870117, -52.00000762939453, -51.326717376708984, -52.00000762939453, -52.00000762939453, -52.00000762939453, -50.891578674316406, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-22.905380249023438, -52.00000762939453, -44.540184020996094, -32.959877014160156, -31.316978454589844, -39.61259460449219, -46.709102630615234, -52.00000762939453, -52.00000762939453, -39.54548645019531, -38.270240783691406, -50.568355560302734, -52.00000762939453, -52.00000762939453, -51.77106475830078, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-23.648719787597656, -52.00000762939453, -41.64849853515625, -31.547882080078125, -32.27979278564453, -42.3626708984375, -50.3639030456543, -52.00000762939453, -52.00000762939453, -38.41840362548828, -40.804115295410156, -49.36739730834961, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-24.39794158935547, -52.00000762939453, -40.47565460205078, -43.53425598144531, -48.64591979980469, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -47.77417755126953, -47.007041931152344, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-24.977890014648438, -52.00000762939453, -42.62956619262695, -50.15982437133789, -52.00000762939453, -50.803932189941406, -52.00000762939453, -52.00000762939453, -52.00000762939453, -50.154884338378906, -45.75660705566406, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-25.692237854003906, -52.00000762939453, -46.87382125854492, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -50.83448028564453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-26.28009033203125, -52.00000762939453, -49.77739715576172, -52.00000762939453, -50.4478645324707, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-26.853736877441406, -52.00000762939453, -49.03921890258789, -51.70545959472656, -50.449920654296875, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-27.42607879638672, -52.00000762939453, -52.00000762939453, -51.366943359375, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-28.0364990234375, -52.00000762939453, -45.952178955078125, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-28.57563018798828, -52.00000762939453, -42.53356170654297, -51.64838790893555, -49.1612434387207, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -47.76428985595703, -46.53130340576172, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-29.14385986328125, -52.00000762939453, -41.740482330322266, -49.175750732421875, -47.62775802612305, -50.895599365234375, -52.00000762939453, -52.00000762939453, -52.00000762939453, -42.34743118286133, -45.57886505126953, -51.417850494384766, -51.748531341552734, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-29.696327209472656, -52.00000762939453, -41.28403091430664, -45.68781661987305, -41.17302703857422, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -45.361114501953125, -50.11394500732422, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -44.693267822265625, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-30.27649688720703, -52.00000762939453, -42.55542755126953, -38.353492736816406, -38.288780212402344, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -49.54933547973633, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -50.4500732421875, -52.00000762939453, -43.84148025512695, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-30.76153564453125, -52.00000762939453, -42.21661376953125, -38.14850616455078, -36.500396728515625, -44.23223876953125, -52.00000762939453, -52.00000762939453, -51.500389099121094, -52.00000762939453, -50.348907470703125, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-31.271759033203125, -52.00000762939453, -42.263492584228516, -48.517120361328125, -40.63463592529297, -47.13787078857422, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-31.746864318847656, -52.00000762939453, -40.481773376464844, -48.34971237182617, -45.23193359375, -51.875152587890625, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -51.813636779785156, -49.885738372802734, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-32.20770263671875, -52.00000762939453, -38.88898468017578, -42.54080581665039, -39.17876434326172, -47.062232971191406, -52.00000762939453, -52.00000762939453, -44.33647918701172, -47.56691360473633, -45.400657653808594, -49.54484939575195, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-32.613441467285156, -52.00000762939453, -40.139404296875, -41.18113708496094, -39.43474197387695, -44.2694091796875, -52.00000762939453, -52.00000762939453, -41.89671325683594, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -49.20264434814453, -52.00000762939453, -49.59485626220703, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-32.997833251953125, -52.00000762939453, -43.81132888793945, -47.18762969970703, -45.600955963134766, -47.6177864074707, -49.31119918823242, -52.00000762939453, -50.90906524658203, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-33.34651184082031, -52.00000762939453, -46.63326644897461, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -51.9556884765625, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -50.28989791870117, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-33.635032653808594, -52.00000762939453, -44.970314025878906, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -48.401573181152344, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -48.96015548706055, -51.65624237060547, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-33.84202575683594, -52.00000762939453, -42.00102233886719, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453},
{-33.97856140136719, -52.00000762939453, -41.14389419555664, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453, -52.00000762939453}
};

constexpr int kTensorArenaSize = 70000;
alignas(16) uint8_t tensorArena[kTensorArenaSize];

void setup()
{
  // Initialize serial communications at 9600 baud rate
  Serial.begin(9600);
  while (!Serial)
    ; // Wait for the serial port to connect
  
  if (!modelInit(jarvis0_3_0_tflite, tensorArena, kTensorArenaSize))
  {
    Serial.println("Failed to initialize the model!");
    while (1) {}
  }
  Serial.println("Model initialized!");

  //Need to extract features appropriately... how to implement the mel spectrogram?

  modelSetInput(melSpectrogram);
  int t0 = millis();
  modelRunInference();
  int t1 = millis();

  Serial.print("Inference time: ");
  Serial.println(t1-t0);
  modelGetOutput();
}

void loop()
{
  return;
}